# CCPM360 质量控制流程

## 概述

本文档定义了CCPM360项目在提交代码和部署前必须执行的质量控制流程，旨在确保代码质量、构建成功和部署稳定性。

## 提交部署前质控检查清单

### 🔍 必须执行的检查项目

#### 1. 代码质量检查

- [ ] **ESLint检查**: `npm run lint`
- [ ] **代码格式化**: `npm run format`
- [ ] **TypeScript类型检查**: `npm run type-check`
- [ ] **严格TypeScript检查**: `npx tsc --noEmit --strict`

#### 2. 构建验证

- [ ] **完整构建测试**: `npm run build`
- [ ] **构建产物检查**: 确认`.next`目录生成正确
- [ ] **依赖完整性**: 验证所有import的组件和模块存在
- [ ] **Vercel构建模拟**: 模拟生产环境构建过程
- [ ] **Node.js版本兼容性**: 确认版本与Vercel兼容

#### 3. 测试验证

- [ ] **单元测试**: `npm run test`
- [ ] **集成测试**: `npm run test:integration` (如果存在)
- [ ] **E2E测试**: `npm run test:e2e` (如果存在)

#### 4. 安全检查

- [ ] **依赖安全扫描**: `npm audit`
- [ ] **环境变量检查**: 确认敏感信息未硬编码
- [ ] **API密钥安全**: 验证密钥未暴露在客户端代码中
- [ ] **Radix UI依赖检查**: 验证所有使用的Radix组件已安装
- [ ] **依赖完整性验证**: 扫描代码中的import语句并验证依赖

#### 5. 性能检查

- [ ] **Bundle大小分析**: `npm run analyze` (如果配置)
- [ ] **图片优化**: 确认图片格式和大小合理
- [ ] **代码分割**: 验证路由级别的代码分割

#### 6. 数据库和API检查

- [ ] **数据库迁移**: 确认Supabase迁移文件正确
- [ ] **API接口测试**: 验证关键API端点可访问
- [ ] **权限配置**: 检查RLS规则和用户权限

## 🚀 快速执行命令

### 一键质控检查

```bash
# 执行完整的部署前检查
npm run pre-deploy
```

### 分步执行

```bash
# 1. 代码质量
npm run lint
npm run format
npm run type-check

# 2. 构建测试
npm run build

# 3. 测试验证
npm run test

# 4. 安全检查
npm audit
```

## ⚠️ 常见问题和解决方案

### 构建失败

- **模块未找到**: 检查import路径和组件是否存在
- **TypeScript错误**: 修复类型定义和接口问题
- **依赖冲突**: 运行`npm ci`重新安装依赖
- **Radix UI组件缺失**: 运行`npm install @radix-ui/react-[component-name]`安装缺失组件
- **严格TypeScript检查失败**: 修复类型安全问题，添加必要的类型注解

### Vercel部署失败

- **依赖缺失**: 确保所有import的包都在package.json中声明
- **Node.js版本不兼容**: 更新到Vercel支持的版本(18.x, 20.x, 22.x)
- **环境变量未配置**: 在Vercel控制台配置必要的环境变量
- **构建超时**: 优化构建过程，减少不必要的依赖

### 测试失败

- **单元测试**: 检查测试用例和模拟数据
- **集成测试**: 验证API接口和数据库连接
- **快照测试**: 更新过期的组件快照

### 安全问题

- **依赖漏洞**: 运行`npm audit fix`修复已知漏洞
- **敏感信息**: 移除硬编码的密钥和配置
- **权限问题**: 检查Supabase RLS规则配置
- **依赖完整性问题**: 使用`npm ls`检查依赖树，解决版本冲突

## 📋 部署前最终确认

在推送代码到远程仓库前，请确认：

1. ✅ 所有质控检查项目已通过
2. ✅ 本地开发服务器运行正常
3. ✅ 关键功能手动测试通过
4. ✅ 提交信息清晰描述变更内容
5. ✅ 分支策略符合团队规范

## 📖 最佳实践指南

### 开发阶段最佳实践

1. **依赖管理**
   - 使用`npm install`而非`npm add`安装新依赖
   - 定期运行`npm audit`检查安全漏洞
   - 避免安装不必要的依赖包
   - 使用精确版本号避免版本冲突

2. **TypeScript使用**
   - 启用严格模式进行开发
   - 为所有函数参数和返回值添加类型注解
   - 避免使用`any`类型，使用具体类型或`unknown`
   - 定期运行`npx tsc --noEmit --strict`检查类型安全

3. **组件开发**
   - 使用TypeScript接口定义组件Props
   - 为复杂组件编写单元测试
   - 遵循单一职责原则，保持组件简洁
   - 使用Radix UI时确保相关依赖已安装

4. **代码提交**
   - 提交前运行完整的质控检查
   - 编写清晰的提交信息
   - 小步提交，避免大批量变更
   - 使用分支进行功能开发

### 部署前检查清单

- [ ] 本地开发服务器运行正常
- [ ] 所有TypeScript错误已修复
- [ ] 所有ESLint警告已处理
- [ ] 构建过程无错误
- [ ] 关键功能手动测试通过
- [ ] 依赖完整性验证通过
- [ ] 环境变量配置正确

## 🔧 自动化工具

### Git钩子

- **pre-commit**: 自动执行代码格式化和基础检查
- **pre-push**: 执行完整的质控流程

### CI/CD集成

- **GitHub Actions**: 自动化构建和测试
- **Vercel部署**: 生产环境自动部署

## 📚 相关文档

- [开发指南](./DEVELOPMENT_GUIDE.md)
- [架构文档](./docs/architecture/)
- [测试策略](./docs/testing/strategy.md)
- [部署流程](./docs/deployment/)

## 🆘 获取帮助

如果在质控流程中遇到问题：

1. 查看本文档的常见问题部分
2. 检查项目的开发指南
3. 联系团队技术负责人
4. 在项目Issues中提出问题

---

**记住**: 质量控制不是阻碍开发的障碍，而是确保项目稳定性和团队协作效率的重要保障。
