#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# è¿è¡Œlint-stagedè¿›è¡Œä»£ç æ ¼å¼åŒ–å’ŒåŸºç¡€æ£€æŸ¥
npx lint-staged

# è¿è¡ŒESLintæ£€æŸ¥
npm run lint

# è¿è¡ŒTypeScriptä¸¥æ ¼ç±»å‹æ£€æŸ¥
echo "ğŸ” Running strict TypeScript check..."
npx tsc --noEmit --strict

# æ£€æŸ¥ä¾èµ–å®Œæ•´æ€§
echo "ğŸ“¦ Checking dependency integrity..."
node -e "
const fs = require('fs');
const path = require('path');
const glob = require('glob');

const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
const allDeps = { ...packageJson.dependencies, ...packageJson.devDependencies };

const files = glob.sync('src/**/*.{ts,tsx,js,jsx}');
const missingDeps = [];

files.forEach(file => {
  const content = fs.readFileSync(file, 'utf8');
  const importMatches = content.match(/import.*from\s+['\"]([^'\"]+)['\"]/g) || [];
  
  importMatches.forEach(match => {
    const dep = match.match(/from\s+['\"]([^'\"]+)['\"]/)[1];
    if (!dep.startsWith('.') && !dep.startsWith('/') && !allDeps[dep] && !allDeps[dep.split('/')[0]]) {
      missingDeps.push(dep);
    }
  });
});

if (missingDeps.length > 0) {
  console.error('âŒ Missing dependencies:', [...new Set(missingDeps)]);
  process.exit(1);
} else {
  console.log('âœ… All dependencies are properly declared');
}
"

echo "âœ… Pre-commit checks completed successfully!"